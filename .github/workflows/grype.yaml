# .github/workflows/grype.yaml
name: üì¶ DevSecOps - Dependency Scan (Grype SCA)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  grype_scan:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        
      - name: üîé Run Grype Dependency Scan (SCA)
        uses: anchore/scan-action@v6
        id: scan
        # THIS IS CRITICAL: It allows the workflow to continue, 
        # even if high-severity vulnerabilities are found (and the step exits with an error code).
        continue-on-error: true 
        with:
          path: "."
          output-format: json # Changing to 'json' for simpler console printing
          fail-on-severity: high 

      - name: üì§ Print Grype Report Content
        # This step now runs because the previous step is allowed to fail
        run: |
          echo "--- START GRYPE REPORT ---"
          # The scan action saves the file to the path in the output variable
          cat ${{ steps.scan.outputs.output-file }} 
          echo "--- END GRYPE REPORT ---"
          
      - name: ‚¨ÜÔ∏è Upload Grype Report Artifact
        uses: actions/upload-artifact@v4
        with:
          name: grype-security-report
          path: ${{ steps.scan.outputs.output-file }}